/*
 angular-dynamic-layout 2015-01-05 
*/
var dynamicLayoutModule=angular.module("dynamicLayout",["ngAnimate"]).filter("customFilter",["FilterService",function(a){"use strict";return function(b,c){return c?a.applyFilters(b,c):b}}]).filter("customRanker",["RankerService",function(a){"use strict";return function(b,c){return c?a.applyRankers(b,c):b}}]).filter("as",["$parse",function(a){"use strict";return function(b,c,d){return a(d).assign(c,b)}}]).directive("layoutOnLoad",["$rootScope",function(a){"use strict";return{restrict:"A",link:function(b,c){c.bind("load error",function(){a.$broadcast("layout")})}}}]).directive("dynamicLayout",["$timeout","$window","$q","$animate","PositionService",function(a,b,c,d,e){"use strict";return{restrict:"A",scope:{items:"=items",rankers:"=rankers",filters:"=filters"},template:'<div                                                           class="dynamic-layout-item-parent"                                 ng-repeat="it in items |                                               customFilter: filters |                                     customRanker:rankers |                                      as:this:\'filteredItems\'"                       ng-include="it.template"                                ></div>',link:function(d,f){d.templatesToLoad=0;var g=function(){return e.layout(f[0].offsetWidth)},h=function(){var b=c.defer();return a(function(){0===d.templatesToLoad&&b.resolve()}),d.$watch("templatesToLoad",function(a,c){a!==c&&0===d.templatesToLoad&&b.resolve()}),b.promise};d.$on("$includeContentRequested",function(){d.templatesToLoad++}),d.$on("$includeContentLoaded",function(){d.templatesToLoad--}),d.externalScope=function(){return d.$parent},d.$watch("filteredItems",function(a,b){d.$parent.filteredItems=d.filteredItems,angular.equals(a,b)||h().then(function(){g()})},!0),angular.element(b).bind("resize",function(){d.$apply(function(){g()})}),d.$on("layout",function(a,b){g().then(function(){"function"==typeof b&&b()})}),h().then(function(){g()})}}}]);dynamicLayoutModule.factory("FilterService",function(){"use strict";var a=function(a,b){if("function"==typeof b)return b(a);var c=3;if(b.length<c)throw"Incorrect statement";var d=b[0],e=b[1],f=b[2];if(!a[d])return!1;switch(e){case"=":return a[d]==f;case"<":return a[d]<f;case"<=":return a[d]<=f;case">":return a[d]>f;case">=":return a[d]>=f;case"!=":return a[d]!=f;case"in":return a[d]in f;case"not in":return!(a[d]in f);case"contains":if(!(a[d]instanceof Array))throw"contains statement has to be applied on array";return a[d].indexOf(f)>-1;default:throw"Incorrect statement comparator: "+e}},b=function(b,c){for(var d in c)if(a(b,c[d]))return!0;return!1},c=function(a,c){for(var d in c)if(!b(a,c[d]))return!1;return!0};return{applyFilters:function(a,b){var d=[];for(var e in a)c(a[e],b)&&d.push(a[e]);return d}}}),dynamicLayoutModule.factory("PositionService",["$window","$animate","$timeout","$q",function(a,b,c,d){"use strict";var e={},f=[],g=[],h=[],i=function(a){h=[];for(var b=0;a>b;++b)h.push([]);return h},j=function(a){var b=[];for(var c in a){var d;if(a[c].length){var e=a[c][a[c].length-1];d=e.y+e.height}else d=0;b.push(d)}return b},k=function(a,b,c){if(a.columnSpan>b.length)throw"Item too large";for(var d=0,e=0,f=0;f<=b.length-a.columnSpan;++f){var g=f,h=f+a.columnSpan,i=Math.max.apply(Math,b.slice(g,h));(0===f||e>i)&&(e=i,d=f)}var j=[];for(f=d;f<d+a.columnSpan;++f)j.push(f);var k={x:j[0]*c,y:e};return{columns:j,position:k}},l=function(a,b){for(var c=0;c<f.length;++c){var d=j(a),e=k(f[c],d,b);for(var g in e.columns)a[e.columns[g]].push(f[c]);f[c].x=e.position.x,f[c].y=e.position.y}},m=function(){for(var a,b=0;b<f.length;++b)(!a||f[b].width<a)&&(a=f[b].width);return a},n=function(a){for(var b=0;b<f.length;++b)f[b].columnSpan=Math.ceil(f[b].width/a)};return{getItemsDimensionFromDOM:function(){g=document.querySelectorAll(".dynamic-layout-item-parent:not(.ng-leave)"),f=[];for(var b=0;b<g.length;++b)f.push({height:g[b].offsetHeight+parseInt(a.getComputedStyle(g[b]).marginTop),width:g[b].children[0].offsetWidth+parseInt(a.getComputedStyle(g[b].children[0]).marginLeft)});return f},applyToDOM:function(){var a=d.defer(),h=function(a,c){var d=b.addClass(a,"move-items-animation",{from:{position:"absolute"},to:{left:f[c].x+"px",top:f[c].y+"px"}});return d.then(function(){a.classList.remove("move-items-animation"),delete e[c]}),d},i=function(){for(var b=0;b<f.length;++b)e[b]=h(g[b],b);d.all(e).then(function(){a.resolve()})};if(Object.keys(e).length)for(var j in e)b.cancel(e[j]),delete e[j];return c(function(){i(a)}),a.promise},layout:function(a){f=this.getItemsDimensionFromDOM();var b=m(),c=Math.floor(a/b),d=i(c);return n(b),l(d,b),this.applyToDOM()},columns:function(){return h}}}]),dynamicLayoutModule.factory("RankerService",function(){"use strict";return{applyRankers:function(a,b){var c=0,d=function(a,e){var f,g,h=b[c][0],i=b[c][1];if("function"==typeof h)f=h(a),g=h(e);else{if(h in a||h in e){if(!(h in a))return"asc"==i?-1:1;if(!(h in e))return"asc"==i?1:-1}else f=0,g=0;f=a[h],g=e[h]}if(typeof f==typeof g)if("string"==typeof f){var j=f.localeCompare(g);if(1==j)return"asc"==i?1:-1;if(-1==j)return"asc"==i?-1:1}else{if(f>g)return"asc"==i?1:-1;if(g>f)return"asc"==i?-1:1}return++c,b.length>c?d(a,e):0},e=function(a,b){c=0;var e=d(a,b);return e};return b&&a.sort(e),a}}});